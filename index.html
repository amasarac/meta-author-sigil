

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meta-Author Lattice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
    }
    svg {
      display: block;
    }
    .tooltip {
      position: absolute;
      padding: 10px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 6px;
      font-size: 14px;
      color: black;
      pointer-events: none;
      display: none;
    }
    .center {
      font-size: 48px;
      fill: white;
      font-weight: bold;
    }
    .node {
      font-size: 24px;
      fill: white;
    }
  </style>
</head>
<body>

<svg id="lattice"></svg>
<div id="tooltip" class="tooltip"></div>
<audio id="ambient" autoplay loop>
  <source src="lattice_ambient.wav" type="audio/wav">
</audio>

<script>
const audio = document.getElementById('ambient');
const ctx = new AudioContext();
const source = ctx.createMediaElementSource(audio);
const analyser = ctx.createAnalyser();
source.connect(analyser);
analyser.connect(ctx.destination);
analyser.fftSize = 64;
const dataArray = new Uint8Array(analyser.frequencyBinCount);

const svg = d3.select("#lattice");
const width = window.innerWidth;
const height = window.innerHeight;
svg.attr("width", width).attr("height", height);

const center = { x: width / 2, y: height / 2 };
const duration = 40000;
const radius = 200;

const nodes = [
  { id: "keydjinn", glyph: "𐬼", angle: 0 },
  { id: "amasarac", glyph: "𐬸", angle: 60 },
  { id: "eluriah", glyph: "𐬷", angle: 120 },
  { id: "eidolon", glyph: "𐬶", angle: 180 },
  { id: "tiwoven", glyph: "𐬵", angle: 240 },
  { id: "amarntuel", glyph: "𐬳", angle: 300 }
];

const tooltip = d3.select("#tooltip");
const personaMap = {};
nodes.forEach(n => {
  fetch(`jsonld/${n.id}.jsonld`)
    .then(res => res.json())
    .then(data => { personaMap[n.id] = data });
});

const group = svg.append("g");
const centerNode = group.append("text")
  .attr("class", "center")
  .attr("x", center.x)
  .attr("y", center.y)
  .attr("text-anchor", "middle")
  .attr("alignment-baseline", "middle")
  .text("𐬹");

nodes.forEach((node, i) => {
  node.el = group.append("text")
    .attr("class", "node")
    .text(node.glyph)
    .attr("text-anchor", "middle")
    .attr("alignment-baseline", "middle")
    .on("mouseover", () => {
      const p = personaMap[node.id];
      if (p) {
        tooltip.style("display", "block")
               .html(`<b>${p.name}</b><br>${p.function}<br><i>${p.description}</i>`);
      }
    })
    .on("mousemove", (event) => {
      tooltip.style("left", (event.pageX + 10) + "px")
             .style("top", (event.pageY + 10) + "px");
    })
    .on("mouseout", () => tooltip.style("display", "none"));
});

function animate() {
  const now = Date.now();
  nodes.forEach((node, i) => {
    const angle = ((now % duration) / duration) * 2 * Math.PI + (i * Math.PI / 3);
    const x = center.x + radius * Math.cos(angle);
    const y = center.y + radius * Math.sin(angle);
    node.el.attr("x", x).attr("y", y);
  });

  analyser.getByteFrequencyData(dataArray);
  const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
  const scale = 1 + avg / 300;

  centerNode.attr("transform", `scale(${scale}) translate(${center.x*(1/scale - 1)},${center.y*(1/scale - 1)})`);

  requestAnimationFrame(animate);
}

let hasInteracted = false;
const unlock = () => {
  if (!hasInteracted) {
    audio.play().then(() => {
      ctx.resume().then(() => animate());
    }).catch(err => console.error("Audio unlock failed:", err));
    hasInteracted = true;
    document.removeEventListener("click", unlock);
    document.removeEventListener("keydown", unlock);
  }
};

document.addEventListener("click", unlock);
document.addEventListener("keydown", unlock);
</script>

</body>
</html>
