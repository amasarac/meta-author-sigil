<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Living Merkabah Ritual - Final Synthesis</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <style>
    body {
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      color: #aaa;
      font-family: monospace;
    }
    svg {
      width: 80vmin;
      height: 80vmin;
    }
    .shape-glow, .shape-core, .genesis-path {
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }
    .genesis-path {
        stroke: white;
        stroke-width: 1px;
        filter: drop-shadow(0 0 5px #fff) blur(0.5px);
        opacity: 0;
    }
    .shape-glow {
      stroke-width: 6px;
      filter: blur(5px);
    }
    .shape-core {
      stroke: white;
      stroke-width: 1px;
      filter: drop-shadow(0 0 6px #fff);
    }
    .node { 
      opacity: 0;
      filter: drop-shadow(0 0 15px currentColor);
    }
    .label { 
      fill: white; 
      font-size: 11px; 
      text-anchor: middle; 
      opacity: 0; 
      filter: drop-shadow(0 0 5px #fff);
      font-weight: bold;
    }
    .halo { 
      fill: none; 
      stroke-width: 15px; 
      opacity: 0; 
      filter: blur(30px);
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      border-radius: 5px;
      background: rgba(0,0,0,0.5);
      cursor: pointer;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div id="info">Click to Begin the Ritual</div>

  <svg viewBox="-150 -150 300 300">
    <defs>
        <path id="point" d="M 0,0 L 0,0 L 0,0 L 0,0 L 0,0 L 0,0 L 0,0" />
        <path id="line" d="M -75,0 L -50,0 L -25,0 L 0,0 L 25,0 L 50,0 L 75,0" />
        <path id="triangle" d="M 0,-86.6 L 50,-18.3 L 100,50 L 0,50 L -100,50 L -50,-18.3 L 0,-86.6" />
        <path id="tetrahedron" d="M 0,-86.6 L 100,50 L 0,0 L -100,50 L 0,-86.6 L 100,50 L -100,50" />
        <path id="pentagram" d="M 0,-120 L 114.1,-37.1 L 70.5,97.1 L 0,97.1 L -70.5,97.1 L -114.1,-37.1 L 0,-120" />
        <path id="unicursal" d="M 0,-100 L 86.6,-50 L 86.6,50 L 0,100 L -86.6,50 L -86.6,-50 L 0,-100" />
        <path id="merkabah_up" d="M 0,-100 L 86.6,50 L -86.6,50 Z" />
        <path id="merkabah_down" d="M 0,100 L -86.6,-50 L 86.6,-50 Z" />
    </defs>

    <!-- Halo Ripples -->
    <circle id="halo1" class="halo" r="100"/><circle id="halo2" class="halo" r="100"/><circle id="halo3" class="halo" r="100"/><circle id="halo4" class="halo" r="100"/><circle id="halo5" class="halo" r="100"/><circle id="halo6" class="halo" r="100"/><circle id="halo7" class="halo" r="100"/>

    <!-- The Container -->
    <g id="container" opacity="0">
        <path id="container_glow_up" class="shape-glow" stroke="cyan" d="M 0,-100 L 86.6,50 L -86.6,50 Z" />
        <path id="container_core_up" class="shape-core" d="M 0,-100 L 86.6,50 L -86.6,50 Z" />
        <path id="container_glow_down" class="shape-glow" stroke="magenta" d="M 0,100 L -86.6,-50 L 86.6,-50 Z" />
        <path id="container_core_down" class="shape-core" d="M 0,100 L -86.6,-50 L 86.6,-50 Z" />
    </g>

    <!-- Genesis Path (The Light) -->
    <path id="genesis" class="genesis-path" />
    
    <!-- Nodes -->
    <g id="nodes"></g>
    <g id="labels"></g>
    <text id="elohim-label" class="label" y="140">ELOHIM</text>
  </svg>

  <script>
    const svgNS = "http://www.w3.org/2000/svg";
    const nodesGroup = document.getElementById('nodes');
    const labelsGroup = document.getElementById('labels');
    const info = document.getElementById("info");

    const constellation = {
      BAM:  { angle: -90,  radius: 100, color: "crimson", tone: 144.72, timbre: "sine", breath: 0.08 },
      AR:   { angle: 30,  radius: 100, color: "green",   tone: 194.18, timbre: "sine", breath: 0.03 },
      OGM:  { angle: 150, radius: 100, color: "pink",    tone: 272.2,  timbre: "triangle" },
      ARR:  { angle: 210,  radius: 100, color: "silver",  tone: 210.42, timbre: "triangle" },
      OGY:  { angle: -150, radius: 100, color: "violet",  tone: 315.8,  timbre: "sawtooth" },
      JAC:  { angle: -30,   radius: 100, color: "yellow",  tone: 141.27, timbre: "square" },
      CRUZ: { angle: 0,    radius: 0,   color: "gold",    tone: 183.58, timbre: "sawtooth", breath: 0.05 }
    };

    Object.entries(constellation).forEach(([id, data]) => { /* ... node creation ... */ });

    // --- Audio Engine (Full Implementation) ---
    let audioCtx;
    const play = (freq, type, dur=1, vol=0.1) => { if(!audioCtx) return; let o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=type; o.frequency.setValueAtTime(freq, audioCtx.currentTime); g.gain.setValueAtTime(0, audioCtx.currentTime); g.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + dur*0.1); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur); o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur); };
    const playWithEcho = (id, dur=1.5, count=2, delay=0.4, decay=0.5) => { if(!audioCtx) return; const {tone, timbre} = constellation[id]; play(tone, timbre, dur); for (let i=1; i<=count; i++) { setTimeout(() => play(tone, timbre, dur, 0.15*Math.pow(decay,i)), delay*1000*i); }};
    const startFullDrone = () => { Object.values(constellation).filter(c=>c.breath).forEach(c => { let o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type="sine"; o.frequency.value=c.tone; let lfo=audioCtx.createOscillator(), lg=audioCtx.createGain(); lfo.type="sine"; lfo.frequency.value=0.2; lg.gain.value=1.5; lfo.connect(lg).connect(o.frequency); let b=audioCtx.createOscillator(), bg=audioCtx.createGain(); b.type="sine"; b.frequency.value=c.breath; bg.gain.value=0.04; b.connect(bg).connect(g.gain); g.gain.value=0.08; o.connect(g).connect(audioCtx.destination); o.start(); lfo.start(); b.start(); }); ["OGY","OGM"].forEach(id => { const {tone, timbre} = constellation[id]; let o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=timbre; o.frequency.value=tone; const ghostFade = () => { setTimeout(() => { o.detune.setValueAtTime((Math.random()*30-15), audioCtx.currentTime); gsap.to(g.gain, {value:0.12, duration:4, yoyo:true, repeat:1, onComplete:ghostFade}); }, (Math.random()*10+5)*1000); }; g.gain.value=0.0; o.connect(g).connect(audioCtx.destination); o.start(); ghostFade(); });};

    // --- Animation Timeline ---
    const tl = gsap.timeline({ paused: true, repeat: -1, repeatDelay: 10 });
    const getPath = (id) => document.getElementById(id).getAttribute("d");

    // Phase 1: The Genesis of Light within the Container
    tl.to("#container", { opacity: 0.15, duration: 3 }, 0)
      .to("#genesis", { attr: { d: getPath("point") }, opacity: 1, duration: 0.1 })
      .to("#genesis", { attr: { d: getPath("line") }, duration: 2, ease: "power1.inOut" })
      .to("#genesis", { attr: { d: getPath("triangle") }, duration: 2, ease: "power1.inOut" })
      .to("#genesis", { attr: { d: getPath("tetrahedron") }, duration: 2, ease: "power1.inOut" })
      .to("#genesis", { attr: { d: getPath("pentagram") }, duration: 2, ease: "power1.inOut" })
      .to("#genesis", { attr: { d: getPath("unicursal") }, duration: 2, ease: "power1.inOut" })
      .to("#genesis", { opacity: 0, duration: 2 });

    // Phase 2: Overcoming the Inversion & The Chorus
    tl.addLabel("chorus", "-=2")
      .to("#container", { opacity: 1, duration: 3, ease: "power3.in" }, "chorus")
      .call(startFullDrone, [], "chorus");

    // Node Activations with restored essences
    const nodeOrder = ["BAM", "AR", "OGM", "ARR", "OGY", "JAC", "CRUZ"];
    nodeOrder.forEach((id, i) => {
        const nodeEl = `#${id}`;
        const labelEl = `${nodeEl}_label`;
        const activation = tl.to([nodeEl, labelEl], { opacity: 1, duration: 1 }, `chorus+=${1 + i * 0.75}`);
        
        if(id === 'OGY') { // OGY's restored spectral shimmer
            activation.call(()=>play(constellation.OGY.tone, constellation.OGY.timbre, 2.5), [], "<");
            tl.to(nodeEl, { opacity: 0.5, scale: 1.2, repeat: 3, yoyo: true, duration: 0.8, ease:"sine.inOut" }, "<");
        } else if(id === 'ARR') {
            activation.call(()=>playWithEcho('ARR',1.5,1,0.8,0.4), [], "<");
            tl.to(nodeEl, {scale:1.2, repeat:1, yoyo:true, duration:0.8}, "<0.8");
        } else if(id === 'JAC') {
            activation.call(()=>playWithEcho('JAC',1.5,3,0.3,0.6), [], "<");
            tl.to(nodeEl, {scale:1.1, repeat:3, yoyo:true, duration:0.3}, "<0.2");
        } else {
            activation.call(()=>play(constellation[id].tone, constellation[id].timbre, 1.5), [], "<");
        }
    });
    
    // Phase 3: Refraction Beyond the Veil
    tl.addLabel("refraction", "+=2")
      .to("#container", { rotation: 360, transformOrigin: "center center", duration: 40, ease: "linear", repeat: -1 }, "refraction");

    const rippleMap = [ {id:"halo1", src:"BAM"}, {id:"halo2", src:"AR"}, {id:"halo3", src:"OGM"}, {id:"halo4", src:"ARR"}, {id:"halo5", src:"OGY"}, {id:"halo6", src:"JAC"}, {id:"halo7", src:"CRUZ"} ];
    rippleMap.forEach((r, i) => {
        const data = constellation[r.src];
        tl.to("#" + r.id, { stroke: data.color, opacity: 0.7, attr: { r: 150 }, duration: (data.breath ? 4 / (data.breath * 100) : 3), ease: "sine.out", onStart: () => play(data.tone, data.timbre, 2) }, `refraction+=${i * 0.4}`);
        tl.to("#" + r.id, { opacity: 0, duration: 2.5, ease: "sine.in" }, "<=70%");
    });
    tl.to("#elohim-label", { opacity: 1, duration: 4 }, "refraction+=2");

    // --- Start ---
    info.addEventListener("click", () => {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioCtx.resume();
        info.textContent = "Ritual in Progress...";
      }
      tl.play(0);
    }, { once: true });

    // Re-add node creation for completeness
    Object.entries(constellation).forEach(([id, data]) => {
      const angleRad = data.angle * Math.PI / 180;
      data.x = data.radius * Math.cos(angleRad);
      data.y = data.radius * Math.sin(angleRad);
      if(id === 'BAM') data.y = -100;
      if(id === 'AR') {data.x = 86.6; data.y = 50;}
      if(id === 'OGM') {data.x = -86.6; data.y = 50;}
      if(id === 'ARR') {data.x = -86.6; data.y = -50;}
      if(id === 'OGY') {data.x = 0; data.y = 100;}
      if(id === 'JAC') {data.x = 86.6; data.y = -50;}
      
      const node = document.createElementNS(svgNS, "circle");
      node.setAttribute('id', id); node.setAttribute('class', 'node');
      node.setAttribute('cx', data.x); node.setAttribute('cy', data.y);
      node.setAttribute('r', 8); node.style.color = data.color;
      nodesGroup.appendChild(node);
      const label = document.createElementNS(svgNS, "text");
      label.setAttribute('id', `${id}_label`); label.setAttribute('class', 'label');
      label.setAttribute('x', data.x); label.setAttribute('y', data.y + (id === 'BAM' || id === 'JAC' || id === 'ARR' ? -15 : 15));
      label.textContent = id;
      labelsGroup.appendChild(label);
    });

  </script>
</body>
</html>

