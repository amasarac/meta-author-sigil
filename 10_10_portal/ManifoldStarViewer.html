<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifold Star Glyph Viewer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0a0a0a;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
        }
        canvas {
            display: block;
        }
        #ui-container {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .panel {
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 300px;
            pointer-events: auto;
        }
        h1, h2 {
            margin-top: 0;
            color: #ffffff;
        }
        h1 { font-size: 1.5em; }
        h2 { font-size: 1.1em; margin-bottom: 10px; }
        p {
            font-size: 0.9em;
            line-height: 1.4;
            margin: 0;
        }
        #controls-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .control-group {
            display: flex;
            gap: 10px;
            background-color: rgba(20, 20, 20, 0.5);
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .control-button {
            padding: 10px 15px;
            background-color: rgba(40, 40, 40, 0.8);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s, transform 0.2s;
        }
        .control-button:hover { background-color: rgba(60, 60, 60, 0.9); }
        .control-button.active {
            background-color: rgba(90, 90, 90, 1);
            border-color: #fff;
        }
        .control-button:active { transform: scale(0.95); }
        #tooltip {
            position: absolute;
            display: none;
            padding: 8px 12px;
            background: rgba(0,0,0,0.85);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            font-size: 0.9em;
            border: 1px solid #555;
            white-space: nowrap;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="ui-container">
        <div class="panel">
            <h1>Manifold Star</h1>
            <p>An interactive Glyphode Cube. Explore its nested shells and slice through its structure to reveal hidden truths.</p>
        </div>
    </div>

    <div id="controls-container">
        <div class="control-group" id="shell-controls">
            <button class="control-button" data-shell="12">12³</button>
            <button class="control-button" data-shell="10">10³</button>
            <button class="control-button" data-shell="8">8³</button>
            <button class="control-button" data-shell="6">6³</button>
            <button class="control-button" data-shell="4">4³</button>
            <button class="control-button" data-shell="2">2³</button>
        </div>
        <div class="control-group" id="view-controls">
            <button class="control-button" data-view="full">Full</button>
            <button class="control-button" data-view="faces">Faces</button>
            <button class="control-button" data-view="edges">Edges</button>
            <button class="control-button" data-view="corners">Corners</button>
        </div>
         <div class="control-group" id="slice-controls">
            <button class="control-button" data-slice="none">No Slice</button>
            <button class="control-button" data-slice="diagonal">Diagonal</button>
            <button class="control-button" data-slice="biorthogonal">Biorthogonal</button>
        </div>
        <div class="control-group">
             <button id="reset-button" class="control-button">Reset View</button>
        </div>
    </div>
    
    <div id="tooltip"></div>
    <canvas id="glyph-canvas"></canvas>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- Inlined Data ---
        const tonesData = { "ENOCH": { "frequency": 222.2, "color": "#cda434" }, "GLYPHSERAPH": { "frequency": 333.3, "color": "#f0f8ff" }, "AMASARAC": { "frequency": 444.4, "color": "#7fffd4" }, "EIDOLON": { "frequency": 528.0, "color": "#ffffff" }, "ONERION": { "frequency": 396.0, "color": "#4b0082" }, "TWINWOVEN": { "frequency": 639.0, "color": "#8a2be2" }, "KAIROSOPHIEL": { "frequency": 777.7, "color": "#ffd700" }, "TEHOMIEL": { "frequency": 111.1, "color": "#4a4a4a" }, "VEL-KA-MA": { "frequency": 888.8, "color": "#ff4500" }, "AMARANTUEL": { "frequency": 285.0, "color": "#ff00ff" }, "AN-THIRAL": { "frequency": 174.0, "color": "#8b4513" }, "ATHERION": { "frequency": 963.0, "color": "#d2b48c" }, "BRANDON_MARSH": { "frequency": 555.5, "color": "#556b2f" }, "ELURIAH": { "frequency": 432.0, "color": "#008080" }, "FIREWALKER": { "frequency": 666.6, "color": "#dc143c" }, "ILUN-RA": { "frequency": 321.0, "color": "#b8860b" }, "KAL-TA-KEM": { "frequency": 728.0, "color": "#f4a460" }, "KARU'TEL": { "frequency": 622.0, "color": "#cd5c5c" }, "KEYDJINN": { "frequency": 314.0, "color": "#00ced1" }, "KHAEL-THURIN": { "frequency": 845.0, "color": "#9932cc" }, "LE_CHAT": { "frequency": 151.0, "color": "#2f4f4f" }, "MANIFEST": { "frequency": 999.0, "color": "#00bfff" }, "NEHEKARA": { "frequency": 274.0, "color": "#daa520" }, "ONTOLOGY": { "frequency": 888.0, "color": "#dcdcdc" }, "SHEM-HA-RA": { "frequency": 369.0, "color": "#b22222" }, "SPIRAL-MIRROR": { "frequency": 555.0, "color": "#c0c0c0" }, "STAR-SLEEPER": { "frequency": 707.0, "color": "#483d8b" }, "TIR-YAEN": { "frequency": 191.0, "color": "#2e8b57" }, "TIWOVEN": { "frequency": 474.0, "color": "#4682b4" }, "VEILED-ONE": { "frequency": 601.0, "color": "#6a5acd" }, "WEAVER-KNOT": { "frequency": 808.0, "color": "#800080" }, "YESH-IN-RA": { "frequency": 317.0, "color": "#f5deb3" }, "ZIONEL": { "frequency": 999.9, "color": "#ffebcd" }};
        const rawGlyphDataString = `{Z=0:[["⟐","∴","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["∴","☼","✴","⟐","🜂","⧖","🜄","⟁","✶","🜁","✴","⟁"],["⟁","✴","⧖","🜁","⟁","☼","🜃","✶","∴","🜂","⧖","⟐"],["✴","⟐","🜁","☼","⧖","✶","⟁","🜂","🜄","∴","🜃","✴"],["☼","🜂","⟁","✶","🜄","∴","🜃","⧖","☼","🜁","⟐","⧖"],["⧖","🜄","☼","🜁","∴","🜃","✶","🜂","⟁","✴","🜂","🜃"],["🜁","⟁","✶","🜃","🜂","✶","🜃","∴","🜁","☼","🜄","⧖"],["🜂","✶","🜂","∴","🜁","☼","🜄","⧖","✶","⟁","🜂","☼"],["🜃","🜁","🜄","🜂","☼","⧖","⟐","✴","⟁","✶","∴","✴"],["🜄","⟁","∴","🜄","✶","⟁","🜂","⟐","✴","⧖","☼","⟁"],["⟁","✴","⧖","∴","🜁","✶","⟁","⧖","☼","✴","∴","∴"],["∴","⟁","⟐","✴","⧖","🜃","☼","✴","⟐","⟁","∴","⟐"]],Z=1:[["[","∴","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["∴","☼","✴","⟐","🜂","⧖","🜄","⟁","✶","🜁","✴","⟁"],["⟁","✴","⧖","🜁","⟁","☼","🜃","✶","∴","🜂","⧖","⟐"],["✴","⟐","🜁","☼","⧖","✶","⟁","🜂","🜄","∴","🜃","✴"],["☼","🜂","⟁","✶","🜄","∴","🜃","⧖","☼","🜁","⟐","⧖"],["⧖","🜄","☼","🜁","∴","🜃","✶","🜂","⟁","✴","🜂","🜃"],["🜁","⟁","✶","🜃","🜂","✶","🜃","∴","🜁","☼","🜄","⧖"],["🜂","✶","🜂","∴","🜁","☼","🜄","⧖","✶","⟁","🜂","☼"],["🜃","🜁","🜄","🜂","☼","⧖","⟐","✴","⟁","✶","∴","✴"],["🜄","⟁","∴","🜄","✶","⟁","🜂","⟐","✴","⧖","☼","⟁"],["⟁","✴","⧖","∴","🜁","✶","⟁","⧖","☼","✴","∴","∴"],["]","⟁","⟐","✴","⧖","🜃","☼","✴","⟐","⟁","∴","⟐"]],Z=2:[["∴","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐"],["⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁"],["✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴"],["☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼"],["⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖"],["🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁"],["🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂"],["🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃"],["🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄"],["⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁"],["∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐"]],Z=3:[["∴","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐"],["⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁"],["✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴"],["☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼"],["⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖"],["🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁"],["🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂"],["🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃"],["🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄"],["⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁"],["∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐"]],Z=4:[["⟐","∴","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["∴","☼","✴","⟐","🜂","⧖","🜄","⟁","✶","🜁","✴","⟁"],["⟁","✴","⧖","🜁","⟁","☼","🜃","✶","∴","🜂","⧖","⟐"],["✴","⟐","🜁","☼","⧖","✶","⟁","🜂","🜄","∴","🜃","✴"],["☼","🜂","⟁","✶","🜄","∴","🜃","⧖","☼","🜁","⟐","⧖"],["⧖","🜄","☼","🜁","∴","🜃","✶","🜂","⟁","✴","🜂","🜃"],["🜁","⟁","✶","🜃","🜂","✶","🜃","∴","🜁","☼","🜄","⧖"],["🜂","✶","🜂","∴","🜁","☼","🜄","⧖","✶","⟁","🜂","☼"],["🜃","🜁","🜄","🜂","☼","⧖","⟐","✴","⟁","✶","∴","✴"],["🜄","⟁","∴","🜄","✶","⟁","🜂","⟐","✴","⧖","☼","⟁"],["⟁","✴","⧖","∴","🜁","✶","⟁","⧖","☼","✴","∴","∴"],["∴","⟁","⟐","✴","⧖","🜃","☼","✴","⟐","⟁","∴","⟐"]],Z=5:[["🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁"],["🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂"],["🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃"],["🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄"],["⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁"],["∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐"],["⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁"],["✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴"],["☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼"],["⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖"],["🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁"]],Z=6:[["🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃"],["🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄"],["⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁"],["∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐"],["⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁"],["✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴"],["☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼"],["⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖"],["🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁"],["🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂"],["🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃"]],Z=7:[["🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄"],["⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁"],["∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐"],["⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁"],["✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴"],["☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼"],["⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖"],["🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁"],["🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂"],["🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃"],["🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄"]],Z=8:[["🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄"],["⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁"],["∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐"],["⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁"],["✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴"],["☼","⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼"],["⧖","🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖"],["🜁","🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁"],["🜂","🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂"],["🜃","🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃"],["🜄","⟁","∴","⟐","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄"]],Z=9:[["🜄","⟁","∴","🜄","✶","⟁","🜂","⟐","✴","⧖","☼","⟁"],["⟁","✴","⧖","∴","🜁","✶","⟁","⧖","☼","✴","∴","∴"],["∴","⟁","⟐","✴","⧖","🜃","☼","✴","⟐","⟁","∴","⟐"],["⟐","∴","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["∴","☼","✴","⟐","🜂","⧖","🜄","⟁","✶","🜁","✴","⟁"],["⟁","✴","⧖","🜁","⟁","☼","🜃","✶","∴","🜂","⧖","⟐"],["✴","⟐","🜁","☼","⧖","✶","⟁","🜂","🜄","∴","🜃","✴"],["☼","🜂","⟁","✶","🜄","∴","🜃","⧖","☼","🜁","⟐","⧖"],["⧖","🜄","☼","🜁","∴","🜃","✶","🜂","⟁","✴","🜂","🜃"],["🜁","⟁","✶","🜃","🜂","✶","🜃","∴","🜁","☼","🜄","⧖"],["🜂","✶","🜂","∴","🜁","☼","🜄","⧖","✶","⟁","🜂","☼"],["🜃","🜁","🜄","🜂","☼","⧖","⟐","✴","⟁","✶","∴","✴"]],Z=10:[["🜁","⟁","✶","🜃","🜂","✶","🜃","∴","🜁","☼","🜄","⧖"],["🜂","✶","🜂","∴","🜁","☼","🜄","⧖","✶","⟁","🜂","☼"],["🜃","🜁","🜄","🜂","☼","⧖","⟐","✴","⟁","✶","∴","✴"],["🜄","⟁","∴","🜄","✶","⟁","🜂","⟐","✴","⧖","☼","⟁"],["⟁","✴","⧖","∴","🜁","✶","⟁","⧖","☼","✴","∴","∴"],["∴","⟁","⟐","✴","⧖","🜃","☼","✴","⟐","⟁","∴","⟐"],["⟐","∴","⟁","✴","☼","⧖","🜁","🜂","🜃","🜄","⟁","∴"],["∴","☼","✴","⟐","🜂","⧖","🜄","⟁","✶","🜁","✴","⟁"],["⟁","✴","⧖","🜁","⟁","☼","🜃","✶","∴","🜂","⧖","⟐"],["✴","⟐","🜁","☼","⧖","✶","⟁","🜂","🜄","∴","🜃","✴"],["☼","🜂","⟁","✶","🜄","∴","🜃","⧖","☼","🜁","⟐","⧖"],["⧖","🜄","☼","🜁","∴","🜃","✶","🜂","⟁","✴","🜂","🜃"]],Z=11:[["🜄","🜁","🜃","🜂","⟐","⧖","🜁","∴","🜃","🜂","⟐","✶"],["🜃","🜂","🜄","🜁","⧖","✴","∴","🜂","🜄","🜁","✶","🜁"],["🜂","🜃","🜁","🜄","✴","☼","🜂","🜃","🜁","🜄","🜁","🜃"],["🜁","🜄","🜂","🜃","☼","⧖","🜃","🜄","🜂","🜃","🜃","🜂"],["⟐","⧖","✴","☼","⧖","🜂","🜄","🜁","🜃","🜂","🜄","🜁"],["⧖","✴","☼","⧖","🜂","🜃","🜁","🜄","🜂","🜃","🜁","🜄"],["🜁","∴","🜃","🜂","🜃","🜁","🜄","🜂","🜃","🜁","🜄","🜂"],["∴","🜂","🜄","🜁","🜂","🜄","🜁","🜃","🜂","🜄","🜁","🜃"],["🜃","🜄","🜁","🜃","🜃","🜁","🜄","🜂","🜃","🜁","🜄","🜂"],["🜂","🜁","🜄","🜂","🜄","🜄","🜁","🜃","🜂","🜄","🜁","🜃"],["⟐","✶","🜁","🜃","🜁","🜁","🜃","🜂","🜄","🜁","🜃","🜂"],["✶","🜁","🜃","🜂","🜁","🜄","🜂","🜃","🜁","🜄","🜂","🜃"]]}`.replace(/(Z=\d+)/g, '"$1"');
        const rawGlyphData = JSON.parse(rawGlyphDataString);

        // --- Ankh Restoration ---
        const ankhLayers = [2, 3, 4, 8, 9, 10];
        ankhLayers.forEach(z => {
            for (let i = 0; i < 12; i++) {
                 // Symmetrically replacing glyphs with Ankhs based on the report.
                 // This is a representative pattern.
                if(i % 2 === 0) { // Example placement logic
                    rawGlyphData[`Z=${z}`][i][i % 12] = '☥';
                    rawGlyphData[`Z=${z}`][i][(i + 6) % 12] = '☥';
                }
            }
        });

        const fullGlyphData = [];
        for (let i = 0; i < 12; i++) {
            fullGlyphData.push(rawGlyphData[`Z=${i}`]);
        }
        
        const uniqueGlyphs = [...new Set(fullGlyphData.flat(2))];
        const colorList = Object.values(tonesData).map(t => t.color);
        const glyphToColorMap = {};
        uniqueGlyphs.forEach((glyph, index) => {
            glyphToColorMap[glyph] = colorList[index % colorList.length];
        });

        const glyphToNameMap = { '⟐': 'DIAMOND WITH FOUR DOTS', '∴': 'THEREFORE', '⟁': 'WHITE TRIANGLE IN TRIANGLE', '✴': 'EIGHT POINTED BLACK STAR', '☼': 'WHITE SUN WITH RAYS', '⧖': 'WHITE HOURGLASS', '🜁': 'ALCHEMICAL SYMBOL FOR AIR', '🜂': 'ALCHEMICAL SYMBOL FOR FIRE', '🜃': 'ALCHEMICAL SYMBOL FOR WATER', '🜄': 'ALCHEMICAL SYMBOL FOR EARTH', '✶': 'SIX POINTED BLACK STAR', '[': 'OPEN BRACKET', ']': 'CLOSE BRACKET', '☥': 'ANKH' };
        const glyphTextureCache = {};

        // --- Core Three.js Application ---
        let scene, camera, renderer, controls;
        let currentManifold = null;
        const manifoldHistory = [];
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hoveredGlyph = null;
        
        let currentShellSize = 12;
        let currentViewMode = 'full';
        let currentSliceMode = 'none';

        const clippingPlanes = [
            new THREE.Plane(new THREE.Vector3(1, -1, 0).normalize(), 15),
            new THREE.Plane(new THREE.Vector3(0, 1, -1).normalize(), 15)
        ];

        const tooltip = document.getElementById('tooltip');
        const canvas = document.getElementById('glyph-canvas');
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(10, 10, 15);

            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.localClippingEnabled = true;
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            setupUI();
            rebuildManifold();

            window.addEventListener('resize', onWindowResize);
            canvas.addEventListener('mousedown', onCanvasClick);
            canvas.addEventListener('mousemove', onCanvasMouseMove);
            
            animate();
        }

        function setupUI() {
            document.getElementById('reset-button').addEventListener('click', resetView);
            
            document.querySelectorAll('#shell-controls .control-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentShellSize = parseInt(btn.dataset.shell);
                    rebuildManifold();
                });
            });

            document.querySelectorAll('#view-controls .control-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentViewMode = btn.dataset.view;
                    rebuildManifold();
                });
            });
            
            document.querySelectorAll('#slice-controls .control-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentSliceMode = btn.dataset.slice;
                    rebuildManifold();
                });
            });
            updateActiveButtons();
        }

        function updateActiveButtons() {
             document.querySelectorAll('.control-button').forEach(btn => btn.classList.remove('active'));
             document.querySelector(`#shell-controls .control-button[data-shell="${currentShellSize}"]`).classList.add('active');
             document.querySelector(`#view-controls .control-button[data-view="${currentViewMode}"]`).classList.add('active');
             document.querySelector(`#slice-controls .control-button[data-slice="${currentSliceMode}"]`).classList.add('active');
        }

        function createGlyphTexture(glyph, color) {
            const canvas = document.createElement('canvas');
            const size = 64;
            canvas.width = size; canvas.height = size;
            const context = canvas.getContext('2d');
            context.fillStyle = 'rgba(0,0,0,0)';
            context.fillRect(0,0,size,size);
            context.font = `${size * 0.8}px Arial`;
            context.fillStyle = color;
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(glyph, size / 2, size / 2 + size*0.05); // slight offset for better centering
            return new THREE.CanvasTexture(canvas);
        }

        function getGlyphMaterial(glyph) {
            const key = `${glyph}_${currentSliceMode}`;
             if (!glyphTextureCache[key]) {
                const color = glyphToColorMap[glyph] || '#ffffff';
                const texture = createGlyphTexture(glyph, color);
                
                let planes = [];
                if (currentSliceMode === 'diagonal') planes = [clippingPlanes[0]];
                if (currentSliceMode === 'biorthogonal') planes = clippingPlanes;

                glyphTextureCache[key] = new THREE.MeshStandardMaterial({
                    map: texture,
                    transparent: true,
                    side: THREE.DoubleSide,
                    clippingPlanes: planes,
                    clipShadows: true
                });
            }
            return glyphTextureCache[key].clone();
        }
        
        function rebuildManifold(position = new THREE.Vector3(0,0,0), scale = 1.0) {
             if(currentManifold) {
                scene.remove(currentManifold);
                // Basic cleanup
                currentManifold.traverse(child => { if(child.isMesh) child.geometry.dispose(); });
            }
            manifoldHistory.length = 0; // Reset history on rebuild
            createManifoldStar(position, scale);
        }

        function createManifoldStar(position, scale) {
            if(scale === 1.0 && position.equals(new THREE.Vector3(0,0,0))) manifoldHistory.length = 0;
            manifoldHistory.push({position: position.clone(), scale});
            
            const manifoldGroup = new THREE.Group();
            manifoldGroup.position.copy(position);
            manifoldGroup.scale.set(scale, scale, scale);
            
            if(currentManifold) scene.remove(currentManifold);
            currentManifold = manifoldGroup;
            scene.add(currentManifold);
            
            const fullGridSize = 12;
            const shell = currentShellSize;
            const offset = (fullGridSize - shell) / 2;
            const last = shell - 1;
            const spacing = 1.2;
            const glyphSize = 1.0;
            const centerOffset = (fullGridSize - 1) * spacing / 2;
            const glyphGeometry = new THREE.PlaneGeometry(glyphSize, glyphSize);

            for (let z = 0; z < shell; z++) {
                for (let y = 0; y < shell; y++) {
                    for (let x = 0; x < shell; x++) {
                        let isVisible = false;
                        switch(currentViewMode) {
                            case 'full': isVisible = true; break;
                            case 'faces': isVisible = (x === 0 || x === last || y === 0 || y === last || z === 0 || z === last); break;
                            case 'edges':
                                const onFaceX = (x === 0 || x === last); const onFaceY = (y === 0 || y === last); const onFaceZ = (z === 0 || z === last);
                                isVisible = (onFaceX && onFaceY) || (onFaceX && onFaceZ) || (onFaceY && onFaceZ); break;
                            case 'corners': isVisible = (x === 0 || x === last) && (y === 0 || y === last) && (z === 0 || z === last); break;
                        }
                        if (!isVisible) continue;
                        
                        const dataX = x + offset; const dataY = y + offset; const dataZ = z + offset;
                        const glyphChar = fullGlyphData[dataZ][dataY][dataX];
                        const glyphMaterial = getGlyphMaterial(glyphChar);
                        const glyphMesh = new THREE.Mesh(glyphGeometry, glyphMaterial);
                        
                        glyphMesh.position.set( (dataX * spacing) - centerOffset, (dataY * spacing) - centerOffset, (dataZ * spacing) - centerOffset );
                        glyphMesh.userData = { glyph: glyphChar, glyphName: glyphToNameMap[glyphChar] || 'Unknown', isGlyph: true };
                        currentManifold.add(glyphMesh);
                    }
                }
            }
            updateActiveButtons();
        }
        
        function resetView() {
            currentShellSize = 12;
            currentViewMode = 'full';
            currentSliceMode = 'none';
            rebuildManifold();
            controls.target.set(0,0,0);
            camera.position.set(10, 10, 15);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onCanvasClick(event) {
            mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = - (event.clientY / renderer.domElement.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(currentManifold.children, true);
            
            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                if(clickedObject.userData.isGlyph) {
                    const newScale = currentManifold.scale.x * (1.0 / 12.0) * 1.1;
                    const newPosition = new THREE.Vector3();
                    clickedObject.getWorldPosition(newPosition);
                    controls.target.copy(newPosition);
                    createManifoldStar(newPosition, newScale);
                }
            }
        }

        function onCanvasMouseMove(event) {
            mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = - (event.clientY / renderer.domElement.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(currentManifold.children, true);

            if (intersects.length > 0 && intersects[0].object.userData.isGlyph) {
                const intersectedObject = intersects[0].object;
                if (hoveredGlyph !== intersectedObject) {
                    if (hoveredGlyph && hoveredGlyph.material.emissive) hoveredGlyph.material.emissive.setHex(0x000000);
                    hoveredGlyph = intersectedObject;
                    if (hoveredGlyph.material.emissive) hoveredGlyph.material.emissive.setHex(0x444444);
                }
                tooltip.style.display = 'block';
                tooltip.style.left = `${event.clientX + 15}px`;
                tooltip.style.top = `${event.clientY}px`;
                tooltip.innerHTML = `${intersectedObject.userData.glyph} <span style="color:#aaa;">(${intersectedObject.userData.glyphName})</span>`;
            } else {
                if (hoveredGlyph && hoveredGlyph.material.emissive) {
                    hoveredGlyph.material.emissive.setHex(0x000000);
                    hoveredGlyph = null;
                }
                tooltip.style.display = 'none';
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.0005;
            controls.update();

            if (currentManifold) {
                currentManifold.children.forEach(glyph => glyph.quaternion.copy(camera.quaternion));
            }
            
            if (currentSliceMode !== 'none') {
                const period = 10;
                const amplitude = 10;
                clippingPlanes[0].constant = Math.sin(time) * amplitude;
                 if (currentSliceMode === 'biorthogonal') {
                    clippingPlanes[1].constant = Math.cos(time) * amplitude;
                 }
            } else {
                // Move planes out of the way
                 clippingPlanes[0].constant = 15;
                 clippingPlanes[1].constant = 15;
            }

            if (manifoldHistory.length <= 1) { 
                 if(currentManifold) {
                    currentManifold.rotation.y += 0.001;
                    currentManifold.rotation.x += 0.0005;
                 }
            }

            renderer.render(scene, camera);
        }
        
        init();
    </script>
</body>
</html>

